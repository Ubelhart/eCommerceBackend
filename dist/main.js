(()=>{"use strict";var e={505:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(r(752)),n=o(r(1)),s=r(274);if("CLUSTER"===s.mode._[0])if(n.default.isPrimary){console.log("Master cluster setting up");for(let e=0;e<s.numCPUs;e++)n.default.fork();n.default.on("exit",(e=>{console.log(`worker ${e.process.pid} died`)}))}else i.default.listen(s.PORT,(()=>{console.log(`Servidor corriendo en http://localhost:${s.PORT}`)})),console.log(`Worker ${process.pid} started`);else i.default.listen(s.PORT,(()=>{console.log(`Servidor corriendo en http://localhost:${s.PORT}`)}))},752:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(81);const i=o(r(114)),n=o(r(422)),s=o(r(455)),u=o(r(860)),d=o(r(508)),a=o(r(687)),c=(0,u.default)();c.use(u.default.static("public")),c.use(u.default.json()),c.use(u.default.urlencoded({extended:!0})),c.use((0,d.default)({secret:"secreto",cookie:{httpOnly:!1,secure:!1,maxAge:6e5},rolling:!0,resave:!0,saveUninitialized:!1})),c.use(a.default.initialize()),c.use(a.default.session()),c.use((0,s.default)()),c.use("/api/carrito",(new i.default).router),c.use("/api/productos",(new n.default).router),c.set("views","./views"),c.set("view engine","ejs"),t.default=c},913:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.serviceAccount=t.sqlite3=t.mariadb=t.mongoDbKey=void 0,r(81),t.mongoDbKey=process.env.MONGO||"mongodb://localhost:27017/ecommerce",t.mariadb={client:"mysql",connection:{host:"127.0.0.1",user:"root",password:"",database:"ecommerce"}},t.sqlite3={client:"sqlite3",connection:{filename:"./src/db/mydb.sqlite"},useNullAsDefault:!0},t.serviceAccount={type:process.env.FIREBASE_type,project_id:process.env.FIREBASE_project_id,private_key_id:process.env.FIREBASE_private_key_id,private_key:process.env.FIREBASE_private_key,client_email:process.env.FIREBASE_client_email,client_id:process.env.FIREBASE_client_id,auth_uri:process.env.FIREBASE_auth_uri,token_uri:process.env.FIREBASE_token_uri,auth_provider_x509_cert_url:process.env.FIREBASE_auth_provider_x509_cert_url,client_x509_cert_url:process.env.FIREBASE_client_x509_cert_url}},89:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=r(147);t.default=class{constructor(e){this.fileName=e,this.config=`./db/${e}`,this.fs=i.promises}createIfNotExist(){return o(this,void 0,void 0,(function*(){try{return yield i.promises.readFile(this.config)}catch(e){if("ENOENT"===e.code)return yield i.promises.writeFile(this.config,"[]").then((()=>{console.log(`No existe ${this.fileName}. Archivo creado.`)})),yield i.promises.readFile(this.config);console.log("Hubo un error",e)}return null}))}}},627:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(r(509));t.default=class{constructor(e){this.config=e,this.admin=i.default}connect(){i.default.initializeApp({credential:i.default.credential.cert(this.config)}),console.log("Firebase connected")}}},231:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(r(514));t.default=class{constructor(e){this.knex=(0,i.default)(e)}}},135:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(185));t.default=class{constructor(e){this.config=e}connect(){return o(this,void 0,void 0,(function*(){try{yield n.default.connect(this.config),console.log("MongoDB connected")}catch(e){console.log("MongoDB connection error",e)}}))}}},817:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=r(971),n=r(216);t.default=class{constructor(){this.postCart=this.postCart.bind(this),this.deleteCart=this.deleteCart.bind(this),this.getCart=this.getCart.bind(this),this.postProduct=this.postProduct.bind(this),this.deleteProduct=this.deleteProduct.bind(this)}postCart(e,t){return o(this,void 0,void 0,(function*(){if(e.user)try{const r=yield i.daoCarts.postCart(e.body,e.user);return r?(yield(0,n.sendWhatsappMessageToAdmin)(e.user.username),yield(0,n.sendWhatsappMessageToCustomer)(e.user.phoneNumber),t.json(`El carrito con el id:${r.id} ha sido agregado`)):t.json({error:"no se pudo agregar el carrito"})}catch(e){return t.status(500).json({error:e.message})}return t.json({error:"debes iniciar sesión para agregar al carrito"})}))}deleteCart(e,t){return o(this,void 0,void 0,(function*(){if(e.user)try{const r=yield i.daoCarts.getCart(e.params.id,e.user);return r?(yield i.daoCarts.deleteCart(r,e.user),t.json(`El carrito con el id:${r.id} ha sido eliminado`)):t.json({error:`el carrito con el id:${e.params.id} no existe`})}catch(e){return t.status(500).json({error:e.message})}return t.json({error:"debes iniciar sesión para eliminar el carrito"})}))}getCart(e,t){return o(this,void 0,void 0,(function*(){if(e.user)try{const r=yield i.daoCarts.getCart(e.params.id,e.user);return r?t.json(r):t.json({error:`el carrito con el id:${e.params.id} no existe`})}catch(e){return t.status(500).json({error:e.message})}return t.json({error:"debes iniciar sesión para ver el carrito"})}))}postProduct(e,t){return o(this,void 0,void 0,(function*(){if(e.user)try{const r=yield i.daoCarts.getCart(e.params.id,e.user);if(r){const o=yield i.daoCarts.postProduct(r,e.body,e.user);return o?t.json(`El producto con el id:${o.id} ha sido agregado`):t.json({error:`el producto no pudo ser agregado al carrito con el id:${e.params.id}`})}return t.json({error:`el carrito con el id:${e.params.id} no existe`})}catch(e){return t.status(500).json({error:e.message})}return t.json({error:"debes iniciar sesión para agregar un producto"})}))}deleteProduct(e,t){return o(this,void 0,void 0,(function*(){if(e.user)try{const r=yield i.daoCarts.getCart(e.params.id,e.user);if(r){const o=yield i.daoCarts.deleteProduct(r,e.params.id_prod,e.user);return o?t.json(`El producto con el id:${o.id} ha sido eliminado`):t.json({error:`el producto con el id:${e.params.id_prod} no existe en el carrito con el id:${e.params.id}`})}return t.json({error:`el carrito con el id:${e.params.id}`})}catch(e){return t.status(500).json({error:e.message})}return t.json({error:"debes iniciar sesión para eliminar un producto"})}))}}},243:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=r(971),s=i(r(645));t.default=class{constructor(){this.getProducts=this.getProducts.bind(this),this.postProduct=this.postProduct.bind(this),this.getProduct=this.getProduct.bind(this),this.putProduct=this.putProduct.bind(this),this.deleteProduct=this.deleteProduct.bind(this)}getProducts(e,t){return o(this,void 0,void 0,(function*(){if(e.params.id)try{const r=yield n.daoProducts.getProduct(e.params.id);return r?t.json(r):t.json({error:`el producto con el id:${e.params.id} no existe`})}catch(e){return s.default.error(e.message),t.status(500).json({message:e.message})}else try{const e=yield n.daoProducts.getProducts();return e?t.json(e):t.json({error:"no hay productos"})}catch(e){return s.default.error(e.message),t.status(500).json({message:e.message})}}))}getProduct(e,t){return o(this,void 0,void 0,(function*(){try{const r=yield n.daoProducts.getProduct(e.params.id);return r?t.json(r):t.json({error:`el producto con el id:${e.params.id} no existe`})}catch(e){return s.default.error(e.message),t.status(500).json({message:e.message})}}))}postProduct(e,t){return o(this,void 0,void 0,(function*(){try{const r=yield n.daoProducts.postProduct(e.body);return(yield n.daoProducts.getProduct(r.id))?t.json(`El producto con el id:${r.id} ha sido creado`):t.json({error:"no se pudo crear el producto"})}catch(e){return s.default.error(e.message),t.status(500).json({message:e.message})}}))}putProduct(e,t){return o(this,void 0,void 0,(function*(){try{if(yield n.daoProducts.getProduct(e.params.id)){const r=yield n.daoProducts.putProduct(e.params.id,e.body);return t.json(`El producto con el id:${r.id} ha sido actualizado`)}return t.json({error:`el producto con el id:${e.params.id} no existe`})}catch(e){return s.default.error(e.message),t.status(500).json({message:e.message})}}))}deleteProduct(e,t){return o(this,void 0,void 0,(function*(){try{const r=yield n.daoProducts.getProduct(e.params.id);return r?(yield n.daoProducts.deleteProduct(r),t.json(`El producto con el id:${r.id} ha sido eliminado`)):t.json({error:`el producto con el id:${e.params.id} no existe`})}catch(e){return s.default.error(e.message),t.status(500).json({message:e.message})}}))}}},808:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(89));class s extends n.default{constructor(e){super(e)}getCarts(){return o(this,void 0,void 0,(function*(){const e=yield this.createIfNotExist();return e?JSON.parse(e.toString()):e}))}getCart(e){return o(this,void 0,void 0,(function*(){const t=yield this.getCarts(),r=parseInt(e);return t.find((e=>e.id===r))}))}postCart(e){return o(this,void 0,void 0,(function*(){const t=yield this.getCarts(),r={timestamp:(new Date).toString(),products:e};return t.length?r.id=t[t.length-1].id+1:r.id=1,t.push(r),yield this.fs.writeFile(this.config,JSON.stringify(t)),r}))}deleteCart({id:e}){return o(this,void 0,void 0,(function*(){const t=yield this.getCarts(),r=parseInt(e),o=t.filter((e=>e.id!==r));this.fs.writeFile(this.config,JSON.stringify(o))}))}postProduct(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.getCarts(),o=r.find((t=>t.id===e.id));return o?(o.products.push(t),yield this.fs.writeFile(this.config,JSON.stringify(r)),t=e.products.find((e=>e.id===t.id))):null}))}deleteProduct(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.getCarts(),o=parseInt(t),i=r.find((t=>t.id===e.id));return!!i&&(i.products.filter((e=>e.id!==o)),this.fs.writeFile(this.config,JSON.stringify(r)),!0)}))}}t.default=s},792:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(627));class s extends n.default{constructor(e){super(e),this.connect(),this.db=this.admin.firestore(),this.query=this.db.collection("carts")}postCart(e){return o(this,void 0,void 0,(function*(){const t={timestamp:(new Date).toString(),products:[]};e&&!e.length?t.products.push(e):e.length&&(t.products=e);const r=this.query.doc(),o=r._path.segments[1];yield r.create(t);const i=yield this.getCart(o);if(i.products)return i}))}deleteCart(e){return o(this,void 0,void 0,(function*(){const t=this.query.doc(e.id);e.products&&(yield t.delete())}))}getCart(e){return o(this,void 0,void 0,(function*(){const t=yield this.query.doc(e),r=yield t.get(),o=Object.assign({id:t.id},r.data());if(o.title)return o}))}postProduct(e,t){return o(this,void 0,void 0,(function*(){const r=this.admin.firestore.FieldValue.arrayUnion,o=this.query.doc(e.id);return e.products?(yield o.update({products:r(t)}),t):t}))}deleteProduct(e,t){return o(this,void 0,void 0,(function*(){const r=this.query.doc(e.id);let o;if(e.products&&(o=e.products.find((e=>e.id===t))),o){const e=this.admin.firestore.FieldValue.arrayRemove;return yield r.update({products:e(o)}),o}return o}))}}t.default=s},303:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(135)),s=r(794),u=i(r(645));class d extends n.default{constructor(e){super(e),this.connect()}postCart(e,{username:t}){return o(this,void 0,void 0,(function*(){const r=new s.Cart;return yield r.save(((r,o)=>{r&&u.default.error(r),o.username=t,o.products=e,o.save()})),r}))}deleteCart({id:e},{username:t}){return o(this,void 0,void 0,(function*(){yield s.Cart.findOneAndDelete({_id:e,username:t})}))}getCart(e,{username:t}){return o(this,void 0,void 0,(function*(){return yield s.Cart.findOne({_id:e,username:t})}))}postProduct({id:e},t,{username:r}){return o(this,void 0,void 0,(function*(){let o;return yield s.Cart.findOneAndUpdate({_id:e,username:r},{$push:{products:t}},{new:!0}).then((e=>{e&&(o=e.products.find((e=>e._id==t._id)))})),o}))}deleteProduct({id:e},t,{username:r}){return o(this,void 0,void 0,(function*(){let o;return yield s.Cart.findOneAndUpdate({_id:e,username:r},{$pull:{products:{_id:t}}}).then((e=>{e&&(o=e.products.find((e=>e._id==t)))})),o}))}}t.default=d},526:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(231));class s extends n.default{constructor(e){super(e)}createIfNotExists(){return o(this,void 0,void 0,(function*(){try{yield this.knex.schema.createTable("carts",(e=>{e.increments("id"),e.string("title"),e.timestamp("timestamp")}))}catch(e){console.log(e.sqlMessage)}}))}createIfNotExistsProducts(){return o(this,void 0,void 0,(function*(){try{yield this.knex.schema.createTable("carts_products",(e=>{e.integer("id"),e.integer("cart_id"),e.string("title"),e.string("description"),e.string("thumbnail"),e.float("price"),e.integer("stock"),e.string("timestamp")}))}catch(e){console.log(e.sqlMessage)}}))}postCart(e){return o(this,void 0,void 0,(function*(){yield this.createIfNotExists(),yield this.createIfNotExistsProducts();const t=yield this.knex("carts").insert({title:"Carrito"});return e.forEach((e=>{e.cart_id=t[0]})),yield this.knex("carts_products").insert(e),this.getCart(t[0].toString())}))}deleteCart({id:e}){return o(this,void 0,void 0,(function*(){yield this.knex("carts_products").where("cart_id",e).del(),yield this.knex("carts").where("id",e).del()}))}getCart(e){return o(this,void 0,void 0,(function*(){try{const t=(yield this.knex.from("carts").select("*").where("id",e))[0];return t.products=yield this.knex.from("carts_products").select("*").where("cart_id",e),t}catch(e){return console.log(e.sqlMessage),!1}}))}postProduct(e,t){return o(this,void 0,void 0,(function*(){return e.products&&(t.cart_id=e.id),yield this.knex("carts_products").insert(t),t}))}deleteProduct(e,t){return o(this,void 0,void 0,(function*(){const r=yield this.knex.from("carts_products").select("*").where("id",t).andWhere("cart_id",e.id);return yield this.knex("carts_products").where("id",t).andWhere("cart_id",e.id).del(),r[0]}))}}t.default=s},971:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.daoProducts=t.daoCarts=void 0,r(81);const s=r(913);let u,d;switch(t.daoCarts=u,t.daoProducts=d,process.env.DB){case"mariaSql":Promise.resolve().then((()=>n(r(526)))).then((({default:e})=>{t.daoCarts=u=new e(s.sqlite3)})),Promise.resolve().then((()=>n(r(470)))).then((({default:e})=>{t.daoProducts=d=new e(s.mariadb)}));break;case"mongoDb":Promise.resolve().then((()=>n(r(303)))).then((({default:e})=>{t.daoCarts=u=new e(s.mongoDbKey)})),Promise.resolve().then((()=>n(r(179)))).then((({default:e})=>{t.daoProducts=d=new e(s.mongoDbKey)}));break;case"firebase":Promise.resolve().then((()=>n(r(792)))).then((({default:e})=>{t.daoCarts=u=new e(s.serviceAccount)})),Promise.resolve().then((()=>n(r(593)))).then((({default:e})=>{t.daoProducts=d=new e(s.serviceAccount)}));break;default:Promise.resolve().then((()=>n(r(808)))).then((({default:e})=>{t.daoCarts=u=new e("carts.json")})),Promise.resolve().then((()=>n(r(722)))).then((({default:e})=>{t.daoProducts=d=new e("products.json")}))}},722:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(89));class s extends n.default{constructor(e){super(e)}getProducts(){return o(this,void 0,void 0,(function*(){const e=yield this.createIfNotExist();return e?JSON.parse(e.toString()):e}))}postProduct(e){return o(this,void 0,void 0,(function*(){const t=yield this.getProducts();return t.length?e.id=t[t.length-1].id+1:e.id=1,e.timestamp=(new Date).toString(),t.push(e),yield this.fs.writeFile(this.config,JSON.stringify(t)),e}))}getProduct(e){return o(this,void 0,void 0,(function*(){const t=parseInt(e);return(yield this.getProducts()).find((e=>e.id===t))}))}putProduct(e,t){return o(this,void 0,void 0,(function*(){const r=parseInt(e),o=(yield this.getProducts()).filter((e=>e.id!==r));return t.id=r,o.push(t),yield this.fs.writeFile(this.config,JSON.stringify(o)),t}))}deleteProduct({id:e}){return o(this,void 0,void 0,(function*(){const t=parseInt(e),r=(yield this.getProducts()).filter((e=>e.id!==t));this.fs.writeFile(this.config,JSON.stringify(r))}))}}t.default=s},593:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(627));class s extends n.default{constructor(e){super(e),this.db=this.admin.firestore(),this.query=this.db.collection("products")}getProducts(){return o(this,void 0,void 0,(function*(){return(yield this.query.get()).docs.map((e=>Object.assign({id:e.id},e.data())))}))}postProduct(e){return o(this,void 0,void 0,(function*(){e.timestamp=(new Date).toString();const t=this.query.doc(),r=t._path.segments[1];yield t.create(e);const o=yield this.getProduct(r);if(o.title)return o}))}getProduct(e){return o(this,void 0,void 0,(function*(){const t=this.query.doc(e),r=yield t.get(),o=Object.assign({id:t.id},r.data());if(o.title)return o}))}putProduct(e,t){return o(this,void 0,void 0,(function*(){const r=this.query.doc(e);yield r.update(t);const o=yield this.getProduct(e);if(o.title)return o}))}deleteProduct(e){return o(this,void 0,void 0,(function*(){const t=this.query.doc(e.id);return!!e.title&&(yield t.delete(),!0)}))}}t.default=s},470:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(231));class s extends n.default{constructor(e){super(e)}createIfNotExists(){return o(this,void 0,void 0,(function*(){try{yield this.knex.schema.createTable("products",(e=>{e.increments("id"),e.string("title"),e.string("description"),e.string("thumbnail"),e.float("price"),e.integer("stock"),e.timestamp("timestamp")}))}catch(e){console.log(e.sqlMessage)}}))}getProducts(){return o(this,void 0,void 0,(function*(){return yield this.knex.from("products").select("*")}))}postProduct(e){return o(this,void 0,void 0,(function*(){yield this.createIfNotExists();const t=yield this.knex("products").insert(e);return yield this.getProduct(t[0].toString())}))}getProduct(e){return o(this,void 0,void 0,(function*(){return(yield this.knex.from("products").select("*").where("id",e))[0]}))}putProduct(e,t){return o(this,void 0,void 0,(function*(){return yield this.knex("products").where("id",e).update(t),yield this.getProduct(e)}))}deleteProduct({id:e}){return o(this,void 0,void 0,(function*(){yield this.knex("products").where("id",e).del()}))}}t.default=s},179:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(135)),s=r(489);class u extends n.default{constructor(e){super(e)}getProducts(){return o(this,void 0,void 0,(function*(){return yield s.Product.find({})}))}postProduct(e){return o(this,void 0,void 0,(function*(){const t=new s.Product(e);return yield t.save()}))}getProduct(e){return o(this,void 0,void 0,(function*(){return yield s.Product.findById(e)}))}putProduct(e,t){return o(this,void 0,void 0,(function*(){return yield s.Product.findByIdAndUpdate(e,t)}))}deleteProduct({id:e}){return o(this,void 0,void 0,(function*(){return yield s.Product.findByIdAndRemove(e)}))}}t.default=u},794:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Cart=void 0;const i=o(r(185)),n=r(489),s=new i.default.Schema({username:{type:String,require:!0},products:[n.productSchema],timestamp:{type:String,default:(new Date).toString()}});t.Cart=i.default.model("carts",s)},489:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Product=t.productSchema=void 0;const i=o(r(185));t.productSchema=new i.default.Schema({title:{type:String,required:!0},description:{type:String,required:!0},thumbnail:{type:String,required:!0},price:{type:Number,required:!0},timestamp:{type:String,default:(new Date).toString()},stock:{type:Number,required:!0}}),t.Product=i.default.model("products",t.productSchema)},12:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=r(185),i=new o.Schema({username:{type:String,required:!0},password:{type:String,required:!0},name:{type:String,required:!0},address:{type:String,required:!0},age:{type:Number,required:!0},phoneNumber:{type:String,required:!0},avatar:{type:String,required:!0}}),n=(0,o.model)("users",i);t.default=n},186:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(r(752)),n=o(r(687)),s=o(r(645));i.default.get("/register",((e,t)=>{t.render("register")})),i.default.post("/register",n.default.authenticate("signup",{successRedirect:"/login",failureRedirect:"/failregister"})),i.default.get("/failregister",((e,t)=>{s.default.info("Fallo al registrar usuario"),t.render("failregister")})),i.default.get("/login",((e,t)=>{t.render("login")})),i.default.post("/login",n.default.authenticate("login",{successRedirect:"/",failureRedirect:"/faillogin"})),i.default.get("/faillogin",((e,t)=>{s.default.info("Fallo al iniciar sesión"),t.render("faillogin")})),i.default.get("/logout",((e,t)=>{if(e.user){const{username:r}=e.user;return e.logOut((e=>e?(s.default.error(e),t.redirect("/login")):t.render("logout",{username:r})))}t.redirect("/login")})),t.default=i.default},114:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(860),n=o(r(817)),s=(0,i.Router)();t.default=class{constructor(){this.router=s,this.cartsController=new n.default,s.use((0,i.json)()),s.use((0,i.urlencoded)({extended:!0})),s.post("/",this.cartsController.postCart),s.delete("/:id",this.cartsController.deleteCart),s.get("/:id/productos",this.cartsController.getCart),s.post("/:id/productos",this.cartsController.postProduct),s.delete("/:id/productos/:id_prod",this.cartsController.deleteProduct)}}},422:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(860),n=o(r(243)),s=o(r(383)),u=(0,i.Router)();t.default=class{constructor(){this.router=u,this.productsController=new n.default,u.use((0,i.json)()),u.use((0,i.urlencoded)({extended:!0})),u.get("/:id?",this.productsController.getProducts),u.post("/",s.default,this.productsController.postProduct),u.put("/:id",s.default,this.productsController.putProduct),u.delete("/:id",s.default,this.productsController.deleteProduct)}}},274:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PORT=t.mode=t.numCPUs=void 0;const i=o(r(566)),n=o(r(37)),s=o(r(186)),u=o(r(645));t.numCPUs=n.default.cpus().length;const d=(0,i.default)(process.argv.slice(2));t.mode=(0,i.default)(process.argv.slice(3)),t.PORT=process.env.PORT||d._[0]||8080,s.default.get("/",((e,t)=>e.user?t.json(e.user):t.redirect("/login"))),s.default.get("/api/randoms",((e,t)=>{const{cant:r}=e.query,o=Number(r)||1e5,i=[];for(let e=0;e<o;e++)i.push(Math.floor(1e3*Math.random()));t.json(i)}));const a={"Argumentos de entrada":process.argv,"Nombre de la plataforma: ":process.platform,"Versión de Node: ":process.version,"Memoria total reservada":process.memoryUsage().heapTotal,"Path de ejecución":process.execPath,"Process id":process.pid,"Número de procesadores presentes en el servidor":"CLUSTER"===t.mode._[0]?t.numCPUs:1,"Carpeta del proyecto":__dirname,Port:t.PORT};s.default.get("/info",((e,t)=>{t.json(a)})),s.default.get("*",((e,t)=>{u.default.warn("Ruta no existente"),t.send("Ruta no existente")}))},383:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){"true"===e.headers.admin?r():t.status(401).json({error:"No autorizado"})}},645:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(r(773)),n=i.default.createLogger({transports:[new i.default.transports.Console({level:"info"}),new i.default.transports.File({filename:"warn.log",level:"warn"}),new i.default.transports.File({filename:"error.log",level:"error"})]});t.default=n},918:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=r(184),s=i(r(645)),u=(0,n.createTransport)({service:"gmail",auth:{user:process.env.MAIL,pass:process.env.MAIL_PASSWORD}});t.default=function(e){return o(this,void 0,void 0,(function*(){const t=yield u.sendMail({from:"Servidor de Tienda",port:587,to:process.env.MAIL,subject:"Nuevo registro",html:`<h1>${e}</h1>`});s.default.info(t)}))}},687:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(r(511)),s=r(55),u=i(r(96)),d=i(r(12)),a=i(r(645)),c=i(r(918));function l(e){return u.default.hashSync(e,u.default.genSaltSync(10),null)}n.default.use("login",new s.Strategy(((e,t,r)=>{d.default.findOne({username:e},((e,o)=>e?r(e):o?function(e,t){return u.default.compareSync(t,e.password)}(o,t)?r(null,o):(a.default.info("Contraseña incorrecta"),r(null,!1)):(a.default.info("Email no encontrado"),r(null,!1))))}))),n.default.use("signup",new s.Strategy({passReqToCallback:!0},(({body:e},t,r,i)=>{d.default.findOne({username:t},((n,s)=>{if(n)return i(n);if(s)return a.default.info("Email ya existe"),i(null,!1);const u=new d.default({username:t,password:l(r),name:e.name,address:e.address,age:e.age,phoneNumber:e.phoneNumber,avatar:e.avatar});u.save((e=>o(void 0,void 0,void 0,(function*(){return e?i(e):(yield(0,c.default)(u),i(null,u))}))))}))}))),n.default.serializeUser((({_id:e},t)=>{t(null,e)})),n.default.deserializeUser(((e,t)=>{d.default.findById(e,((e,r)=>e?t(e):t(null,r)))})),t.default=n.default},216:function(e,t,r){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(e){n(e)}}function u(e){try{d(o.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}d((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sendWhatsappMessageToCustomer=t.sendWhatsappMessageToAdmin=void 0;const n=i(r(202)),s=i(r(645)),u=process.env.TWILIO_ACCOUNT_SID,d=process.env.TWILIO_AUTH_TOKEN,a=(0,n.default)(u,d);t.sendWhatsappMessageToAdmin=e=>o(void 0,void 0,void 0,(function*(){try{const t=yield a.messages.create({body:`Nuevo pedido de ${e}!`,from:`whatsapp:+14${process.env.TWILIO_NUMBER}`,to:`whatsapp:+54${process.env.MY_PHONE}`});s.default.info(t)}catch(e){s.default.error(e)}})),t.sendWhatsappMessageToCustomer=e=>o(void 0,void 0,void 0,(function*(){try{const t=yield a.messages.create({body:"Su pedido ha sido recibido y se encuentra en proceso!",from:`whatsapp:+14${process.env.TWILIO_NUMBER}`,to:`whatsapp:+549${e}`});s.default.info(t)}catch(e){s.default.error(e)}}))},96:e=>{e.exports=require("bcrypt")},455:e=>{e.exports=require("compression")},81:e=>{e.exports=require("dotenv/config")},860:e=>{e.exports=require("express")},508:e=>{e.exports=require("express-session")},509:e=>{e.exports=require("firebase-admin")},514:e=>{e.exports=require("knex")},566:e=>{e.exports=require("minimist")},185:e=>{e.exports=require("mongoose")},184:e=>{e.exports=require("nodemailer")},511:e=>{e.exports=require("passport")},55:e=>{e.exports=require("passport-local")},202:e=>{e.exports=require("twilio")},773:e=>{e.exports=require("winston")},1:e=>{e.exports=require("cluster")},147:e=>{e.exports=require("fs")},37:e=>{e.exports=require("os")}},t={};!function r(o){var i=t[o];if(void 0!==i)return i.exports;var n=t[o]={exports:{}};return e[o].call(n.exports,n,n.exports,r),n.exports}(505)})();